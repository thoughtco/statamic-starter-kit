<section>

    <div class="wrap">

        <div class="map-container bg-[rgba(77,172,233,0.05)] relative">

            <div class="map" x-data='googleMap(
                {
                    center: {
                        lat: {{ latitude }},
                        lng: {{ longitude }},
                    },
                    mapId: "map-display"
                },
                [
                    {
                        lat: {{ latitude }},
                        lng: {{ longitude }},
                        infoWindow: `<div class="infoWindow">"{{ address | nl2br | sanitize }}"</div>`
                    }
                ])'>

                <template x-if="! consentGiven">
                    <div class="consentMessage absolute top-1/2 left-1/2 -translate-y-1/2 -translate-x-1/2 w-full max-w-[50%] font-medium text-center">
                        <p>Please <a href="#" onclick="ConsentPanel.open(); return false;">consent to third party cookies</a> in order to view map content.</p>
                    </div>
                </template>
                <template x-if="consentGiven">
                    <figure id="map-display" class="map-display block bg-[rgba(233,233,233)] w-full h-full object-cover lg:absolute lg:top-0 lg:left-0"></figure>
                </template>

            </div>

        </div>

    </div>

</section>

<script type="text/javascript">
document.addEventListener('alpine:init', () => {
    Alpine.data('googleMap', (settings, locations) => ({
        consentGiven: false,
        locations: locations,
        map: false,
        settings: settings,

        updateConsentGiven() {
            this.consentGiven = ConsentPanel.hasConsentedTo('third-party');
            this.$nextTick(() => this.initMap());
        },

        init() {
              (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
                key: "{{ config.thoughtco.site.maps.api_key }}",
                v: "weekly",
              });

            this.updateConsentGiven();

            this.$watch('locations', () => this.initMap());

            window.addEventListener('statamic-consentpanel:consent-changed', () => {
                this.updateConsentGiven();
            });
        },

        async initMap() {
            const el = this.$el.querySelector('.map-display');

            if (! el) {
                return;
            }

            el.style.pointerEvents = 'all';

            const { Map, InfoWindow } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

            const map = new Map(el, Object.assign({}, {
                zoom: {{ zoom }},
                center: { lat: 0, lng: 0 },
                mapId: "map-display",
                mapTypeControl: {{ mapTypeControl ?? false }},
                panControl: {{ panControl ?? true }},
                streetViewControl: {{ streetViewControl ?? false }},
                zoomControl: {{ zoomControl ?? true }},
                draggable: {{ draggable ?? true }},
            }, this.settings));

            const markers = Object.values(this.locations).map((loc, i) => {
                const styledPin = new PinElement({
                    background: 'rgba(15, 72, 138, 1)',
                    borderColor: 'rgba(0, 69, 77, 0)',
                    glyphColor: 'rgba(15, 72, 138, 1)',
                });

                const marker = new AdvancedMarkerElement({
                    map,
                    position: { lat: loc.lat, lng: loc.lng },
                    content: styledPin.element,
                });

                marker.addListener('click', ({ domEvent, latLng }) => {
                    const {target} = domEvent;
                    map.panTo(latLng);
                    map.setZoom(9);

                    if (loc.infoWindow) {
                        infoWindow.open({ anchor: marker, map });
                    }
                });

                const infoWindow = new InfoWindow({
                    content: loc.infoWindow ?? '',
                    disableAutoPan: false,
                });

                return marker;
            });

            const renderer = {
                render({ count, position }, stats, map) {
                    const color = "rgb(0, 69, 77)";

                    const svg = `<svg fill="${color}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="50" height="50">
            <circle cx="120" cy="120" opacity=".6" r="70" />
            <circle cx="120" cy="120" opacity=".3" r="90" />
            <circle cx="120" cy="120" opacity=".2" r="110" />
            <text x="50%" y="50%" style="fill:#fff" text-anchor="middle" font-size="50" dominant-baseline="middle">${count}</text>
            </svg>`;
                    const title = `Cluster of ${count} markers`,

                    // adjust zIndex to be above other markers
                    zIndex = Number(google.maps.Marker.MAX_ZINDEX) + count;

                    // create cluster SVG element
                    const parser = new DOMParser();
                    const svgEl = parser.parseFromString(svg, "image/svg+xml").documentElement;
                    svgEl.setAttribute("transform", "translate(0 25)");

                    return new AdvancedMarkerElement({
                        map,
                        position,
                        zIndex,
                        title,
                        content: svgEl,
                    });
                }
            };

            new MarkerClusterer({ renderer, markers, map });
        },

    }));
});
</script>
